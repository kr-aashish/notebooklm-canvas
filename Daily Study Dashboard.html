<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Progress Tracker</title>
    <link rel="icon" type="image/png" href="https://us1.discourse-cdn.com/flex002/uploads/anki2/original/2X/2/24bfef76259176f6f6e369b588d07f614d6d631c.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html {
            scroll-behavior: smooth;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Tailwind gray-900 */
        }
        /* --- Custom Scrollbar --- */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        
        /* --- Entry Animation --- */
        @keyframes fadeInSlideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .task-item, .add-task-form-container, .duration-container-new { animation: fadeInSlideUp 0.5s ease-out forwards; }
        
        /* --- Progress Bar --- */
        .progress-bar-fill { 
            transition: width 0.5s ease-in-out; 
            height: 100%;
            border-radius: 9999px;
        }
        .progress-bar-daily {
             background-image: linear-gradient(to right, #818cf8, #a78bfa); /* Indigo-400 to Violet-400 */
        }
        .progress-bar-overall {
            background-image: linear-gradient(to right, #34d399, #38bdf8); /* Emerald-400 to Sky-400 */
        }
        
        /* --- Number Input Customization --- */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] { -moz-appearance: textfield; }

        /* --- Beautiful Loading Spinner --- */
        .loader {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            position: relative;
            animation: rotate 1.2s linear infinite;
            margin: 5rem auto;
        }
        .loader::before, .loader::after {
            content: "";
            box-sizing: border-box;
            position: absolute;
            inset: 0px;
            border-radius: 50%;
            border: 5px solid #1f2937; /* gray-800 */
            animation: prixClipFix 2s linear infinite;
        }
        .loader::after {
            border-color: #38bdf8; /* sky-400 */
            animation: prixClipFix 2s linear infinite, rotate 0.5s linear infinite reverse;
            inset: 6px;
        }
        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes prixClipFix {
            0%   { clip-path: polygon(50% 50%, 0 0, 0 0, 0 0, 0 0, 0 0) }
            25%  { clip-path: polygon(50% 50%, 0 0, 100% 0, 100% 0, 100% 0, 100% 0) }
            50%  { clip-path: polygon(50% 50%, 0 0, 100% 0, 100% 100%, 100% 100%, 100% 100%) }
            75%  { clip-path: polygon(50% 50%, 0 0, 100% 0, 100% 100%, 0 100%, 0 100%) }
            100% { clip-path: polygon(50% 50%, 0 0, 100% 0, 100% 100%, 0 100%, 0 0) }
        }

        /* --- Typewriter Animation --- */
        @keyframes blink-caret {
            from, to { border-color: transparent }
            50% { border-color: #38bdf8; } /* sky-400 */
        }
        .typing-cursor {
            border-right: .1em solid #38bdf8;
            animation: blink-caret .75s step-end infinite;
            white-space: nowrap; /* Keeps cursor at the end */
        }

        /* --- Editable Content Styling --- */
        [contenteditable="true"]:hover {
            outline: 2px dashed #4b5563; /* Tailwind gray-600 */
            border-radius: 4px;
        }
        [contenteditable="true"]:focus {
            outline: 2px solid #38bdf8; /* Tailwind sky-400 */
            background-color: #1f2937; /* Tailwind gray-800 */
            border-radius: 4px;
        }

        /* --- Beautiful Duration Input Styling --- */
        .duration-container-new {
            background: #1f2937; /* gray-800 */
            border-radius: 0.5rem;
            padding: 1rem 1.5rem;
            margin-top: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .duration-label {
            font-size: 1.125rem; /* text-lg */
            font-weight: 600; /* font-semibold */
            color: #d1d5db; /* gray-300 */
        }
        .duration-controls {
            display: flex;
            align-items: center;
            gap: 0.75rem; /* space-x-3 */
        }
        .duration-btn {
            width: 2.5rem; /* w-10 */
            height: 2.5rem; /* h-10 */
            border-radius: 9999px; /* rounded-full */
            background-color: #374151; /* bg-gray-700 */
            color: #e5e7eb; /* text-gray-200 */
            font-size: 1.5rem; /* text-2xl */
            font-weight: 700; /* font-bold */
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px -1px rgba(0,0,0,0.1);
        }
        .duration-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
        }
        .duration-btn.minus:hover {
            background-image: linear-gradient(to right, #f43f5e, #be123c); /* rose-500 to rose-700 */
        }
        .duration-btn.plus:hover {
            background-image: linear-gradient(to right, #10b981, #047857); /* emerald-500 to emerald-700 */
        }
        #duration-days-input {
            width: 5rem; /* w-20 */
            height: 2.5rem; /* h-10 */
            background-color: #111827; /* bg-gray-900 */
            border: 1px solid #4b5563; /* border-gray-600 */
            border-radius: 0.375rem; /* rounded-md */
            text-align: center;
            font-size: 1.25rem; /* text-xl */
            font-weight: 600;
        }
        #duration-days-input:focus {
            outline: none;
            border-color: #34d399; /* emerald-400 */
            box-shadow: 0 0 0 3px rgba(52, 211, 153, 0.3);
        }
    </style>
</head>
<body class="text-gray-200 antialiased">

<div class="container mx-auto max-w-4xl p-4 sm:p-6 md:p-8">
    <header class="text-center mb-8">
        <h1 class="text-4xl sm:text-5xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-emerald-400 to-cyan-400 pb-2 min-h-[56px] sm:min-h-[72px]"></h1>
        <p class="text-gray-400 mt-2 text-lg min-h-[28px]"></p>
    </header>
    
    <main id="main-content" class="space-y-3">
        <!-- Loader is displayed here initially -->
        <div class="loader"></div>
        <p class="text-center text-gray-400">Loading your tracker...</p>
    </main>

    <footer class="text-center mt-12 text-gray-500 text-sm">
        <p class="min-h-[20px]"></p>
    </footer>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {

        let tasks = [];
        let progressState = {};
        let dailyProgressState = {};
        let durationInDays = 7;

        const mainContentContainer = document.getElementById('main-content');
        const titleElement = document.querySelector('header h1');
        const subtitleElement = document.querySelector('header p');
        const footerElement = document.querySelector('footer p');
        
        // --- App Initialization ---
        setTimeout(() => {
            initializeAppUI();
        }, 1000);

        function loadStateFromLocal() {
            durationInDays = parseInt(localStorage.getItem('studyDurationDays') || '7', 10);
            
            const savedTasks = localStorage.getItem('studyTasks');
            tasks = savedTasks ? JSON.parse(savedTasks) : [];

            const savedProgress = localStorage.getItem('studyProgressState');
            progressState = savedProgress ? JSON.parse(savedProgress) : {};
            
            // Handle daily progress reset
            const lastVisitDate = localStorage.getItem('studyLastVisitDate');
            const todayDate = new Date().toLocaleDateString();
            if (lastVisitDate === todayDate) {
                const savedDailyProgress = localStorage.getItem('studyDailyProgressState');
                dailyProgressState = savedDailyProgress ? JSON.parse(savedDailyProgress) : {};
            } else {
                localStorage.setItem('studyDailyProgressState', JSON.stringify({}));
                localStorage.setItem('studyLastVisitDate', todayDate);
            }

            syncAndValidateState();
        }
        
        function getSavedTexts() {
            const savedTitle = localStorage.getItem('studyTrackerTitle') || 'Study Progress Tracker';
            const savedSubtitle = localStorage.getItem('studyTrackerSubtitle') || 'Your customizable study plan & progress tracker.';
            const savedFooter = localStorage.getItem('studyTrackerFooter') || 'Happy studying!';
            return { title: savedTitle, subtitle: savedSubtitle, footer: savedFooter };
        }

        function syncAndValidateState() {
            const taskIds = new Set(tasks.map(t => t.id));
            Object.keys(progressState).forEach(id => {
                if (!taskIds.has(id)) {
                    delete progressState[id]; 
                }
            });
             Object.keys(dailyProgressState).forEach(id => {
                if (!taskIds.has(id)) {
                    delete dailyProgressState[id]; 
                }
            });
            tasks.forEach(task => {
                if (progressState[task.id] === undefined) progressState[task.id] = 0;
                if (dailyProgressState[task.id] === undefined) dailyProgressState[task.id] = 0;
            });
        }

        function saveState() {
            localStorage.setItem('studyDurationDays', durationInDays);
            localStorage.setItem('studyTasks', JSON.stringify(tasks));
            localStorage.setItem('studyProgressState', JSON.stringify(progressState));
            localStorage.setItem('studyDailyProgressState', JSON.stringify(dailyProgressState));
        }

        function saveTextState() {
            localStorage.setItem('studyTrackerTitle', titleElement.textContent);
            localStorage.setItem('studyTrackerSubtitle', subtitleElement.textContent);
            localStorage.setItem('studyTrackerFooter', footerElement.textContent);
        }

        function render() {
            mainContentContainer.innerHTML = ''; 

            const tasksContainer = document.createElement('div');
            tasksContainer.id = 'tasks-container';
            tasksContainer.className = 'space-y-4';
            
            if (tasks.length === 0) {
                 tasksContainer.innerHTML = `<div class="text-center text-gray-500 py-10">No tasks yet. Add one below to get started!</div>`;
            } else {
                tasks.forEach((task, taskIndex) => {
                    const taskTotalGoal = task.totalGoal;
                    const taskItem = document.createElement('div');
                    taskItem.className = 'task-item bg-gray-800 rounded-lg shadow-md p-4 flex flex-col gap-4';
                    taskItem.style.animationDelay = `${taskIndex * 50}ms`;
                    taskItem.innerHTML = `
                        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
                            <div class="w-full sm:w-auto flex-grow sm:pr-4">
                               <div class="flex justify-between items-baseline mb-2">
                                    <span class="font-semibold text-lg text-gray-200">${task.name}</span>
                                    <span id="task-progress-text-${task.id}" class="text-sm font-medium text-gray-400">0 / ${taskTotalGoal}</span>
                                </div>
                                <div class="space-y-2">
                                    <div>
                                        <div class="text-xs text-gray-400 mb-1">Daily Goal</div>
                                        <div class="w-full bg-gray-700 rounded-full h-2.5">
                                            <div id="task-progress-bar-daily-${task.id}" class="progress-bar-fill progress-bar-daily" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    <div>
                                        <div class="text-xs text-gray-400 mb-1">Overall Progress</div>
                                        <div class="w-full bg-gray-700 rounded-full h-2.5">
                                            <div id="task-progress-bar-overall-${task.id}" class="progress-bar-fill progress-bar-overall" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2 sm:space-x-3 flex-shrink-0 self-end sm:self-center">
                                <button class="control-btn remove-btn w-8 h-8 rounded-full bg-gray-700 hover:bg-rose-600 transition-colors flex items-center justify-center" data-task="${task.id}" title="Remove Task">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                </button>
                                <button class="control-btn minus-btn w-8 h-8 rounded-full bg-gray-700 hover:bg-red-500 transition-colors flex items-center justify-center font-bold text-xl" data-task="${task.id}" data-change="-1" title="Increase remaining count">-</button>
                                <div class="flex items-center space-x-1">
                                    <span class="text-gray-400 text-sm whitespace-nowrap">Remaining:</span>
                                    <input type="number" class="task-input-remaining w-14 text-center bg-gray-900 border border-gray-600 rounded-md h-8 focus:ring-2 focus:ring-sky-500 focus:border-sky-500" value="0" min="0" data-task="${task.id}">
                                    <span class="text-gray-400">/</span>
                                    <input type="number" class="task-input-total w-14 text-center bg-gray-900 border border-gray-600 rounded-md h-8 focus:ring-2 focus:ring-sky-500 focus:border-sky-500" value="${taskTotalGoal}" min="0" data-task="${task.id}">
                                </div>
                                <button class="control-btn plus-btn w-8 h-8 rounded-full bg-gray-700 hover:bg-green-500 transition-colors flex items-center justify-center font-bold text-xl" data-task="${task.id}" data-change="1" title="Decrease remaining count">+</button>
                            </div>
                        </div>
                    `;
                    tasksContainer.appendChild(taskItem);
                });
            }
            mainContentContainer.appendChild(tasksContainer);
            mainContentContainer.insertAdjacentHTML('beforeend', `
                <div class="add-task-form-container bg-gray-800/50 rounded-lg p-4 mt-6">
                    <h3 class="text-lg font-semibold text-gray-300 mb-3">Add New Task</h3>
                    <form id="add-task-form" class="flex flex-col sm:flex-row gap-3">
                        <input type="text" id="new-task-name" placeholder="Task Name" class="flex-grow bg-gray-900 border border-gray-600 rounded-md h-10 px-3 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" required>
                        <input type="number" id="new-task-goal" placeholder="Total Goal" class="w-full sm:w-32 bg-gray-900 border border-gray-600 rounded-md h-10 px-3 text-center focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" min="1" required>
                        <button type="submit" class="bg-emerald-600 hover:bg-emerald-700 rounded-md h-10 px-5 font-semibold transition-colors flex items-center justify-center">Add Task</button>
                    </form>
                </div>
            `);

             mainContentContainer.insertAdjacentHTML('beforeend', `
                <div class="duration-container-new">
                    <span class="duration-label">Total Study Duration</span>
                    <div class="duration-controls">
                        <button id="duration-minus-btn" class="duration-btn minus">-</button>
                        <input type="number" id="duration-days-input" value="${durationInDays}" min="1">
                        <span class="text-lg text-gray-400">days</span>
                        <button id="duration-plus-btn" class="duration-btn plus">+</button>
                    </div>
                </div>
            `);
            updateUI();
        }

        function updateUI() {
            tasks.forEach(task => {
                const totalGoal = Number(task.totalGoal);
                const totalCompleted = Number(progressState[task.id] || 0);
                const todaysCompleted = Number(dailyProgressState[task.id] || 0);
                const remaining = totalGoal - totalCompleted;
                const dailyGoal = Math.ceil(totalGoal / durationInDays);

                const overallPercent = totalGoal > 0 ? (totalCompleted / totalGoal) * 100 : 0;
                const dailyPercent = dailyGoal > 0 ? (todaysCompleted / dailyGoal) * 100 : 0;
                
                const remainingInput = document.querySelector(`.task-input-remaining[data-task="${task.id}"]`);
                const totalInput = document.querySelector(`.task-input-total[data-task="${task.id}"]`);
                const dailyBar = document.getElementById(`task-progress-bar-daily-${task.id}`);
                const overallBar = document.getElementById(`task-progress-bar-overall-${task.id}`);
                const progressText = document.getElementById(`task-progress-text-${task.id}`);

                if(remainingInput) remainingInput.value = remaining;
                if(totalInput) totalInput.value = totalGoal;
                if(dailyBar) dailyBar.style.width = `${Math.min(100, dailyPercent)}%`;
                if(overallBar) overallBar.style.width = `${Math.min(100, overallPercent)}%`;
                if(progressText) progressText.textContent = `${totalCompleted} / ${totalGoal}`;
            });
        }
        
        function attachEventListeners() {
            mainContentContainer.addEventListener('input', (e) => {
                const taskId = e.target.dataset.task;
                if (taskId) {
                    const task = tasks.find(t => t.id === taskId);
                    if (!task) return;
                    
                    const oldCompleted = progressState[task.id] || 0;

                    if (e.target.classList.contains('task-input-remaining')) {
                        const remainingValue = parseInt(e.target.value, 10);
                        if (!isNaN(remainingValue)) {
                            const totalGoal = Number(task.totalGoal);
                            const newCompleted = Math.max(0, Math.min(totalGoal - remainingValue, totalGoal));
                            const delta = newCompleted - oldCompleted;
                            
                            progressState[taskId] = newCompleted;
                            dailyProgressState[taskId] = (dailyProgressState[taskId] || 0) + delta;
                        }
                    }

                    if (e.target.classList.contains('task-input-total')) {
                        const newTotalGoal = parseInt(e.target.value, 10);
                        if (!isNaN(newTotalGoal) && newTotalGoal >= 0) {
                            task.totalGoal = newTotalGoal;
                            if(newTotalGoal < progressState[taskId]) {
                                progressState[taskId] = newTotalGoal;
                            }
                        }
                    }
                    saveState();
                    updateUI();
                } else if (e.target.id === 'duration-days-input') {
                    const value = parseInt(e.target.value, 10);
                    if (!isNaN(value) && value > 0) {
                        durationInDays = value;
                        saveState();
                        updateUI();
                    }
                }
            });

            mainContentContainer.addEventListener('click', (e) => {
                const controlBtn = e.target.closest('.control-btn');
                const durationBtn = e.target.closest('.duration-btn');

                if (controlBtn) {
                    const { task: taskId, change } = controlBtn.dataset;
                    const task = tasks.find(t => t.id === taskId);
                    if (!task) return;

                    if (change) {
                        const totalGoal = Number(task.totalGoal);
                        let currentCompleted = progressState[taskId] || 0;
                        let newCompleted = currentCompleted + parseInt(change, 10);
                        newCompleted = Math.max(0, Math.min(newCompleted, totalGoal));
                        
                        if (newCompleted !== currentCompleted) {
                            progressState[taskId] = newCompleted;
                            dailyProgressState[taskId] = (dailyProgressState[taskId] || 0) + parseInt(change, 10);
                        }
                    } else if (controlBtn.classList.contains('remove-btn')) {
                        tasks = tasks.filter(t => t.id !== taskId);
                        delete progressState[taskId];
                        delete dailyProgressState[taskId];
                        render(); // Re-render to remove the element
                    }
                    saveState();
                    updateUI();
                } else if (durationBtn) {
                     const change = durationBtn.id === 'duration-minus-btn' ? -1 : 1;
                    const newValue = durationInDays + change;
                    if (newValue > 0) {
                        durationInDays = newValue;
                        document.getElementById('duration-days-input').value = durationInDays;
                        saveState();
                        updateUI();
                    }
                }
            });

            mainContentContainer.addEventListener('submit', (e) => {
                if (e.target.id === 'add-task-form') {
                    e.preventDefault();
                    const nameInput = document.getElementById('new-task-name');
                    const goalInput = document.getElementById('new-task-goal');
                    const name = nameInput.value.trim();
                    const goal = parseInt(goalInput.value, 10);

                    if (name && !isNaN(goal) && goal > 0) {
                        const newTask = { id: `task-${Date.now()}`, name, totalGoal: goal };
                        tasks.push(newTask);
                        progressState[newTask.id] = 0;
                        dailyProgressState[newTask.id] = 0;
                        saveState();
                        render();
                        nameInput.value = '';
                        goalInput.value = '';
                        nameInput.focus();
                    }
                }
            });
        }
        
        function typeWriter(element, text, callback) {
            let i = 0;
            const speed = 50;
            element.innerHTML = '';
            element.classList.add('typing-cursor');

            function type() {
                if (i < text.length) {
                    element.innerHTML += text.charAt(i);
                    i++;
                    setTimeout(type, speed);
                } else {
                    element.classList.remove('typing-cursor');
                    element.setAttribute('contenteditable', 'true');
                    if (callback) callback();
                }
            }
            type();
        }

        function initializeAppUI() {
            loadStateFromLocal();
            render();
            attachEventListeners();
            
            const { title, subtitle, footer } = getSavedTexts();

            typeWriter(titleElement, title, () => {
                typeWriter(subtitleElement, subtitle, () => {
                    window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
                    setTimeout(() => typeWriter(footerElement, footer, null), 800);
                });
            });
        }

        titleElement.addEventListener('blur', saveTextState);
        subtitleElement.addEventListener('blur', saveTextState);
        footerElement.addEventListener('blur', saveTextState);
    });
</script>
</body>
</html>
