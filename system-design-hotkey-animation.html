<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Design: Hot Key Problem (Celebrity Problem)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
            animation: fadeInDown 0.8s ease;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .section {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            animation: fadeInUp 0.8s ease;
        }

        .section-title {
            font-size: 1.8em;
            color: #667eea;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .badge {
            display: inline-block;
            padding: 5px 15px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 20px;
            font-size: 0.5em;
            font-weight: bold;
        }

        /* Problem Visualization */
        .problem-visual {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 20px;
        }

        .problem-box {
            position: relative;
            padding: 20px;
            border-radius: 15px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            min-height: 200px;
        }

        .problem-box h3 {
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .stat {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
            margin-bottom: 10px;
            animation: pulse 2s infinite;
        }

        /* Architecture Diagram */
        .architecture {
            position: relative;
            min-height: 600px;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            overflow: hidden;
        }

        .layer {
            margin-bottom: 40px;
        }

        .layer-title {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .components {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .component {
            position: relative;
            padding: 20px 30px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 150px;
            text-align: center;
        }

        .component:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .component.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            animation: glow 1.5s infinite;
        }

        .component-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        /* Data Flow Animation */
        .flow-container {
            position: relative;
            height: 400px;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            overflow: hidden;
        }

        .flow-node {
            position: absolute;
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9em;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .flow-packet {
            position: absolute;
            width: 20px;
            height: 20px;
            background: #f5576c;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(245, 87, 108, 0.5);
            animation: movePacket 3s infinite;
        }

        /* Sharded Counter Visualization */
        .shard-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .shard {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            padding: 20px;
            border-radius: 12px;
            color: white;
            text-align: center;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .shard:hover {
            transform: scale(1.05);
        }

        .shard.hot {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            animation: pulse 1s infinite;
        }

        .shard-number {
            font-size: 0.8em;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .shard-count {
            font-size: 1.8em;
            font-weight: bold;
        }

        /* Metrics Dashboard */
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .metric-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 20px;
            border-radius: 12px;
            color: white;
            text-align: center;
        }

        .metric-value {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
            animation: countUp 2s ease;
        }

        .metric-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        /* Traffic Visualization */
        .traffic-viz {
            position: relative;
            height: 300px;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            overflow: hidden;
        }

        .traffic-bar {
            position: absolute;
            bottom: 20px;
            width: 40px;
            background: linear-gradient(to top, #667eea, #764ba2);
            border-radius: 8px 8px 0 0;
            transition: height 0.5s ease;
            cursor: pointer;
        }

        .traffic-bar:hover {
            opacity: 0.8;
        }

        .traffic-label {
            position: absolute;
            bottom: 0;
            width: 40px;
            text-align: center;
            font-size: 0.7em;
            color: #666;
        }

        /* Control Panel */
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn.secondary {
            background: linear-gradient(135deg, #f093fb, #f5576c);
        }

        /* Animations */
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.05);
                opacity: 0.9;
            }
        }

        @keyframes glow {
            0%, 100% {
                box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            }
            50% {
                box-shadow: 0 4px 30px rgba(102, 126, 234, 0.8);
            }
        }

        @keyframes movePacket {
            0% {
                transform: translateY(0) translateX(0);
                opacity: 1;
            }
            100% {
                transform: translateY(300px) translateX(50px);
                opacity: 0;
            }
        }

        @keyframes countUp {
            from {
                opacity: 0;
                transform: scale(0.5);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Redis Cluster Visualization */
        .redis-cluster {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .redis-node {
            background: linear-gradient(135deg, #d53369, #daae51);
            padding: 20px;
            border-radius: 12px;
            color: white;
            text-align: center;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .redis-node:hover {
            transform: translateY(-5px);
        }

        .redis-node.active {
            animation: pulse 1s infinite;
        }

        /* Kafka Stream */
        .kafka-stream {
            position: relative;
            height: 150px;
            background: #2d3748;
            border-radius: 15px;
            padding: 20px;
            overflow: hidden;
            margin-top: 20px;
        }

        .kafka-message {
            position: absolute;
            padding: 10px 15px;
            background: #48bb78;
            color: white;
            border-radius: 8px;
            font-size: 0.8em;
            animation: streamMessage 4s linear infinite;
            white-space: nowrap;
        }

        @keyframes streamMessage {
            from {
                left: -100px;
            }
            to {
                left: 100%;
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .problem-visual {
                grid-template-columns: 1fr;
            }

            .redis-cluster {
                grid-template-columns: repeat(2, 1fr);
            }

            .section {
                padding: 20px;
            }
        }

        /* Code Block */
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 12px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            overflow-x: auto;
            margin-top: 15px;
        }

        .code-comment {
            color: #68d391;
        }

        .code-keyword {
            color: #fc8181;
        }

        .code-string {
            color: #f6e05e;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üî• System Design: The Celebrity Problem</h1>
            <p>Handling Extreme Skew & Hot Keys in Distributed Systems</p>
        </div>

        <!-- Problem Definition -->
        <div class="section">
            <h2 class="section-title">
                ‚ö†Ô∏è The Problem
                <span class="badge">Justin Bieber Effect</span>
            </h2>
            <div class="problem-visual">
                <div class="problem-box">
                    <h3>üé§ Celebrity Post Goes Viral</h3>
                    <div class="stat">
                        <span>Followers:</span>
                        <span id="followers">100M+</span>
                    </div>
                    <div class="stat">
                        <span>Likes in 10 min:</span>
                        <span id="likes">10M+</span>
                    </div>
                    <div class="stat">
                        <span>Write QPS:</span>
                        <span id="writeQPS">16.6K/sec</span>
                    </div>
                    <div class="stat">
                        <span>Read QPS:</span>
                        <span id="readQPS">166K/sec</span>
                    </div>
                </div>
                <div class="problem-box" style="background: linear-gradient(135deg, #ff0844 0%, #ffb199 100%);">
                    <h3>üí• System Impact</h3>
                    <div class="stat">
                        <span>Hot Shard Load:</span>
                        <span>üî• 95%</span>
                    </div>
                    <div class="stat">
                        <span>DB CPU:</span>
                        <span>‚ö° 100%</span>
                    </div>
                    <div class="stat">
                        <span>P99 Latency:</span>
                        <span>‚è±Ô∏è 5000ms+</span>
                    </div>
                    <div class="stat">
                        <span>Error Rate:</span>
                        <span>‚ùå 15%</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Architecture Overview -->
        <div class="section">
            <h2 class="section-title">
                üèóÔ∏è Solution Architecture
                <span class="badge">Event-Driven</span>
            </h2>
            <div class="architecture">
                <!-- Client Layer -->
                <div class="layer">
                    <div class="layer-title">üì± Client Layer</div>
                    <div class="components">
                        <div class="component" data-layer="client">
                            <div class="component-icon">üì±</div>
                            <div>Mobile App</div>
                        </div>
                        <div class="component" data-layer="client">
                            <div class="component-icon">üíª</div>
                            <div>Web App</div>
                        </div>
                    </div>
                </div>

                <!-- API Layer -->
                <div class="layer">
                    <div class="layer-title">üåê API Gateway & Load Balancer</div>
                    <div class="components">
                        <div class="component" data-layer="api">
                            <div class="component-icon">üö™</div>
                            <div>API Gateway</div>
                        </div>
                        <div class="component" data-layer="api">
                            <div class="component-icon">‚öñÔ∏è</div>
                            <div>Load Balancer</div>
                        </div>
                        <div class="component" data-layer="api">
                            <div class="component-icon">üõ°Ô∏è</div>
                            <div>Rate Limiter</div>
                        </div>
                    </div>
                </div>

                <!-- Service Layer -->
                <div class="layer">
                    <div class="layer-title">‚öôÔ∏è Service Layer</div>
                    <div class="components">
                        <div class="component" data-layer="service">
                            <div class="component-icon">‚ù§Ô∏è</div>
                            <div>Like Service</div>
                        </div>
                        <div class="component" data-layer="service">
                            <div class="component-icon">üìä</div>
                            <div>Counter Service</div>
                        </div>
                        <div class="component" data-layer="service">
                            <div class="component-icon">üìù</div>
                            <div>Post Service</div>
                        </div>
                        <div class="component" data-layer="service">
                            <div class="component-icon">üîç</div>
                            <div>Anti-Abuse</div>
                        </div>
                    </div>
                </div>

                <!-- Message Queue -->
                <div class="layer">
                    <div class="layer-title">üì® Message Queue</div>
                    <div class="components">
                        <div class="component" data-layer="queue">
                            <div class="component-icon">üåä</div>
                            <div>Kafka Cluster</div>
                        </div>
                    </div>
                </div>

                <!-- Cache & Storage -->
                <div class="layer">
                    <div class="layer-title">üíæ Cache & Storage Layer</div>
                    <div class="components">
                        <div class="component" data-layer="storage">
                            <div class="component-icon">‚ö°</div>
                            <div>Redis Cluster</div>
                        </div>
                        <div class="component" data-layer="storage">
                            <div class="component-icon">üóÑÔ∏è</div>
                            <div>PostgreSQL</div>
                        </div>
                        <div class="component" data-layer="storage">
                            <div class="component-icon">üìä</div>
                            <div>Data Warehouse</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="controls">
                <button class="btn" onclick="animateFlow()">‚ñ∂Ô∏è Animate Data Flow</button>
                <button class="btn secondary" onclick="resetAnimation()">üîÑ Reset</button>
            </div>
        </div>

        <!-- Sharded Counters -->
        <div class="section">
            <h2 class="section-title">
                üéØ Sharded Counter Solution
                <span class="badge">Key Innovation</span>
            </h2>
            <p style="margin-bottom: 20px; color: #666;">
                Instead of a single counter per post, we split it into multiple shards.
                Each like increments a random shard, distributing load across nodes.
            </p>
            <div class="shard-container" id="shardContainer">
                <!-- Shards will be generated by JavaScript -->
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn" onclick="simulateLikes()">‚ù§Ô∏è Simulate 1000 Likes</button>
                <button class="btn secondary" onclick="resetShards()">üîÑ Reset Counters</button>
            </div>
            <div class="code-block">
<span class="code-comment">// Sharded Counter Implementation</span>
<span class="code-keyword">func</span> IncrementLike(postID, userID <span class="code-keyword">int64</span>) {
    <span class="code-comment">// Pick random shard (0-15)</span>
    shardID := hash(userID) % <span class="code-string">16</span>

    key := <span class="code-string">fmt.Sprintf("post:%d:shard:%d", postID, shardID)</span>
    redis.INCR(key)

    <span class="code-comment">// Periodically aggregate shards</span>
    <span class="code-keyword">if</span> time.Now().Second() % <span class="code-string">5</span> == <span class="code-string">0</span> {
        total := aggregateShards(postID)
        updateDB(postID, total)
    }
}
            </div>
        </div>

        <!-- Redis Cluster Visualization -->
        <div class="section">
            <h2 class="section-title">
                ‚ö° Redis Cluster (In-Memory Counters)
                <span class="badge">Sub-millisecond</span>
            </h2>
            <div class="redis-cluster" id="redisCluster">
                <!-- Redis nodes will be generated by JavaScript -->
            </div>
            <div class="kafka-stream">
                <div style="color: white; margin-bottom: 10px; font-weight: bold;">
                    üì® Kafka Event Stream (likes_events)
                </div>
                <div class="kafka-message" style="animation-delay: 0s;">
                    {"post_id": 123, "user_id": 456, "op": "LIKE"}
                </div>
                <div class="kafka-message" style="animation-delay: 1s;">
                    {"post_id": 123, "user_id": 789, "op": "LIKE"}
                </div>
                <div class="kafka-message" style="animation-delay: 2s;">
                    {"post_id": 123, "user_id": 321, "op": "LIKE"}
                </div>
            </div>
        </div>

        <!-- Metrics Dashboard -->
        <div class="section">
            <h2 class="section-title">
                üìä Real-Time Metrics
                <span class="badge">Live</span>
            </h2>
            <div class="metrics">
                <div class="metric-card">
                    <div class="metric-label">Total QPS</div>
                    <div class="metric-value" id="metricQPS">125K</div>
                </div>
                <div class="metric-card" style="background: linear-gradient(135deg, #f093fb, #f5576c);">
                    <div class="metric-label">Cache Hit Rate</div>
                    <div class="metric-value" id="metricCache">98.5%</div>
                </div>
                <div class="metric-card" style="background: linear-gradient(135deg, #4facfe, #00f2fe);">
                    <div class="metric-label">P99 Latency</div>
                    <div class="metric-value" id="metricLatency">45ms</div>
                </div>
                <div class="metric-card" style="background: linear-gradient(135deg, #43e97b, #38f9d7);">
                    <div class="metric-label">DB Load</div>
                    <div class="metric-value" id="metricDB">12%</div>
                </div>
            </div>
        </div>

        <!-- Traffic Distribution -->
        <div class="section">
            <h2 class="section-title">
                üìà Traffic Distribution (Before vs After)
                <span class="badge">Balanced</span>
            </h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                <div>
                    <h3 style="text-align: center; color: #f5576c; margin-bottom: 15px;">
                        ‚ùå Before (Single DB Counter)
                    </h3>
                    <div class="traffic-viz" id="trafficBefore"></div>
                </div>
                <div>
                    <h3 style="text-align: center; color: #43e97b; margin-bottom: 15px;">
                        ‚úÖ After (Sharded Redis Counters)
                    </h3>
                    <div class="traffic-viz" id="trafficAfter"></div>
                </div>
            </div>
        </div>

        <!-- Key Takeaways -->
        <div class="section">
            <h2 class="section-title">
                üí° Key Takeaways
            </h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
                <div style="padding: 20px; background: #f0fdf4; border-left: 4px solid #43e97b; border-radius: 8px;">
                    <h3 style="color: #166534; margin-bottom: 10px;">‚úÖ Denormalize Counters</h3>
                    <p style="color: #166534;">Store counts in the posts table instead of COUNT(*) queries</p>
                </div>
                <div style="padding: 20px; background: #eff6ff; border-left: 4px solid #4facfe; border-radius: 8px;">
                    <h3 style="color: #1e40af; margin-bottom: 10px;">‚ö° Use Redis Sharding</h3>
                    <p style="color: #1e40af;">Split counters across multiple Redis shards per post</p>
                </div>
                <div style="padding: 20px; background: #fef3c7; border-left: 4px solid #fbbf24; border-radius: 8px;">
                    <h3 style="color: #92400e; margin-bottom: 10px;">üì® Event-Driven Architecture</h3>
                    <p style="color: #92400e;">Use Kafka to decouple writes from reads</p>
                </div>
                <div style="padding: 20px; background: #fce7f3; border-left: 4px solid #f093fb; border-radius: 8px;">
                    <h3 style="color: #831843; margin-bottom: 10px;">üéØ Eventual Consistency</h3>
                    <p style="color: #831843;">Accept slight staleness for massive scalability gains</p>
                </div>
                <div style="padding: 20px; background: #f3e8ff; border-left: 4px solid #a855f7; border-radius: 8px;">
                    <h3 style="color: #581c87; margin-bottom: 10px;">üõ°Ô∏è Rate Limiting</h3>
                    <p style="color: #581c87;">Prevent abuse with per-user and per-post limits</p>
                </div>
                <div style="padding: 20px; background: #ffedd5; border-left: 4px solid #fb923c; border-radius: 8px;">
                    <h3 style="color: #7c2d12; margin-bottom: 10px;">üìä Approximate for UI</h3>
                    <p style="color: #7c2d12;">Show "10M+" instead of exact counts above thresholds</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Shards
        function initShards() {
            const container = document.getElementById('shardContainer');
            container.innerHTML = '';
            for (let i = 0; i < 16; i++) {
                const shard = document.createElement('div');
                shard.className = 'shard';
                shard.innerHTML = `
                    <div class="shard-number">Shard ${i}</div>
                    <div class="shard-count" id="shard-${i}">0</div>
                `;
                container.appendChild(shard);
            }
        }

        // Initialize Redis Nodes
        function initRedis() {
            const container = document.getElementById('redisCluster');
            container.innerHTML = '';
            for (let i = 0; i < 8; i++) {
                const node = document.createElement('div');
                node.className = 'redis-node';
                node.innerHTML = `
                    <div style="font-size: 2em; margin-bottom: 10px;">‚ö°</div>
                    <div style="font-weight: bold;">Redis ${i}</div>
                    <div style="font-size: 0.8em; margin-top: 5px; opacity: 0.9;">
                        ${Math.floor(Math.random() * 50 + 50)}K ops/sec
                    </div>
                `;
                container.appendChild(node);
            }
        }

        // Initialize Traffic Bars
        function initTraffic() {
            const beforeContainer = document.getElementById('trafficBefore');
            const afterContainer = document.getElementById('trafficAfter');

            beforeContainer.innerHTML = '';
            afterContainer.innerHTML = '';

            // Before: Highly skewed
            const beforeHeights = [250, 40, 35, 30, 25, 20, 15, 10];
            const afterHeights = [85, 90, 82, 88, 95, 87, 91, 86];

            beforeHeights.forEach((height, i) => {
                const bar = document.createElement('div');
                bar.className = 'traffic-bar';
                bar.style.height = height + 'px';
                bar.style.left = (i * 60 + 50) + 'px';
                if (i === 0) {
                    bar.style.background = 'linear-gradient(to top, #f5576c, #ff0844)';
                }
                const label = document.createElement('div');
                label.className = 'traffic-label';
                label.style.left = (i * 60 + 50) + 'px';
                label.textContent = `DB${i}`;
                beforeContainer.appendChild(bar);
                beforeContainer.appendChild(label);
            });

            afterHeights.forEach((height, i) => {
                const bar = document.createElement('div');
                bar.className = 'traffic-bar';
                bar.style.height = height + 'px';
                bar.style.left = (i * 60 + 50) + 'px';
                bar.style.background = 'linear-gradient(to top, #43e97b, #38f9d7)';
                const label = document.createElement('div');
                label.className = 'traffic-label';
                label.style.left = (i * 60 + 50) + 'px';
                label.textContent = `Shard${i}`;
                afterContainer.appendChild(bar);
                afterContainer.appendChild(label);
            });
        }

        // Simulate Likes
        function simulateLikes() {
            const shards = 16;
            const likes = 1000;

            for (let i = 0; i < likes; i++) {
                setTimeout(() => {
                    const randomShard = Math.floor(Math.random() * shards);
                    const countElement = document.getElementById(`shard-${randomShard}`);
                    const currentCount = parseInt(countElement.textContent);
                    countElement.textContent = currentCount + 1;

                    // Add visual effect
                    const shardElement = countElement.closest('.shard');
                    shardElement.classList.add('hot');
                    setTimeout(() => {
                        shardElement.classList.remove('hot');
                    }, 300);
                }, i * 10);
            }
        }

        // Reset Shards
        function resetShards() {
            for (let i = 0; i < 16; i++) {
                document.getElementById(`shard-${i}`).textContent = '0';
            }
        }

        // Animate Flow
        function animateFlow() {
            const components = document.querySelectorAll('.component');
            components.forEach(comp => comp.classList.remove('active'));

            let delay = 0;
            const layers = ['client', 'api', 'service', 'queue', 'storage'];

            layers.forEach((layer, index) => {
                setTimeout(() => {
                    document.querySelectorAll(`[data-layer="${layer}"]`).forEach(comp => {
                        comp.classList.add('active');
                    });

                    // Activate Redis nodes
                    if (layer === 'storage') {
                        const redisNodes = document.querySelectorAll('.redis-node');
                        redisNodes.forEach((node, i) => {
                            setTimeout(() => {
                                node.classList.add('active');
                            }, i * 200);
                        });
                    }
                }, delay);
                delay += 800;
            });
        }

        // Reset Animation
        function resetAnimation() {
            const components = document.querySelectorAll('.component');
            components.forEach(comp => comp.classList.remove('active'));
            const redisNodes = document.querySelectorAll('.redis-node');
            redisNodes.forEach(node => node.classList.remove('active'));
        }

        // Update Metrics Dynamically
        function updateMetrics() {
            setInterval(() => {
                const qps = Math.floor(Math.random() * 50000 + 100000);
                const cache = (Math.random() * 2 + 97).toFixed(1);
                const latency = Math.floor(Math.random() * 20 + 35);
                const db = Math.floor(Math.random() * 5 + 10);

                document.getElementById('metricQPS').textContent = (qps / 1000).toFixed(0) + 'K';
                document.getElementById('metricCache').textContent = cache + '%';
                document.getElementById('metricLatency').textContent = latency + 'ms';
                document.getElementById('metricDB').textContent = db + '%';
            }, 2000);
        }

        // Initialize everything on page load
        window.onload = function() {
            initShards();
            initRedis();
            initTraffic();
            updateMetrics();

            // Auto-play animation once
            setTimeout(() => {
                animateFlow();
            }, 1000);
        };
    </script>
</body>
</html>